#!/bin/bash

clear

# demo1 | Version: jan_19_2019-gyn

echo -e "ARM Tool Beaglebone Black\n"
echo -e 'Project: https://github.com/sodmlx/beaglebone-tool\n'

read -p "Project Name: " ID

# check project name.
if [ -d .*_${ID} ];
then
	cd .*_${ID}
else
	mkdir -p .build_$ID
	cd .*_${ID}
fi

# project build.
DIR_BUILD=.build_${ID}

width=$(xwininfo -root | awk '$1=="Width:" {print $2}')
height=$(xwininfo -root | awk '$1=="Height:" {print $2}')

# linaro toolchain gcc.
MIRROR_LINARO="https://releases.linaro.org/components/toolchain/binaries/"

# mirror: u-boot (universal bootloader).
MIRROR_UBOOT="https://gitlab.denx.de/u-boot/u-boot"
UBOOT_NAME="u-boot"

# get all versions of linaro gcc compiler.
versions=$(curl -s "$MIRROR_LINARO" | grep binaries)
versions=$(echo "${versions//}" | sed -e "s/<a href=\"\/components\/toolchain\/binaries\///g" | sed 's/\/"//g' | sort)

# backup project folder.
backup_project(){
	tar -cf 2020-$ID-$(date +%d-%m)-bkp.tar.gz .*_$ID
	mv 2020-*-bkp.tar.gz $HOME
	rm -rf .*_$ID
}

# GCC (arm-linux-gnueabihf).
gcc_arm(){ pkglist=""
  for pkg in $versions; do pkglist="$pkglist FALSE $pkg"; done

	choices=`zenity --title="Graphical Tool for CROSS Compile"\
		--width=$width --height=$height --text="Choose item:"\
                --list --column="Selected" --column="Linaro Toolchain Package"\
                --radiolist $pkglist --ok-label="Build Source" --cancel-label="Back" 2>/dev/null`

	if [ $? -eq 0 ]; then
                IFS="|"
        	for choice in $choices
        	do
			package=$(curl -s $MIRROR_LINARO$choice/arm-linux-gnueabihf/ | grep -E '*x86.*_arm-linux-gnueabihf.tar.xz"')
			package=$(echo $package | sed -e "s/<a href=\"\/components\/toolchain\/binaries\/"$choice"\/arm-linux-gnueabihf//g")
			package=${package%?};
			package=$(echo ${package// /} | cut -c 2-)
			cd $DIR_BUILD
			wget $MIRROR_LINARO$choice/arm-linux-gnueabihf/$package -q --show-progress
			tar -xvf $package
                        dir=$(ls -d */)
                        bin="bin/arm-linux-gnueabihf-"
                        pwd=$(pwd)
                        echo "CC=$pwd/$dir$bin" >> ~/.bash_profile

			# update: source ~/.bash_profile
			zenity --title="Config Manual" --width=500 --height=100\
				--warning --text "update this file: ~/.bash_profile and test GCC ARM support: ${CC}gcc --version"
				sleep 2
		done
	        IFS=""

        	else
            		sleep 1
        fi
}

# U-Boot.
uboot(){
	if [ -d ${UBOOT_NAME} ]; then
		echo -e "\nU-Boot Project Status [OK]\n"
        else
		echo -e "\nU-Boot Setup\n"
		git clone --progress --verbose $MIRROR_UBOOT
        	cd u-boot/
        	tag_list=$(git tag | grep v2)
        	echo $tag_list
		choices=`zenity --title="Graphical Tool for CROSS Compile"\
                	--width=$width --height=$height\
                	--text="Choose item:" --list --column="Selected" --column="U-Boot Tag Version"\
                	--radiolist $tag_list`

		git checkout $choices -b tmp
        	tag=$(git branch -v)
	fi
}

kernel(){
  cd $DIR_BUILD
  git clone https://github.com/RobertCNelson/bb-kernel
  # cd bb-kernel/
  # git checkout origin/am33x-v4.15 -b tmp
  # ./build_kernel.sh
}

# file system support.
fs_build(){
  cd $DIR_BUILD
  wget https://rcn-ee.com/rootfs/eewiki/minfs/debian-9.3-minimal-armhf-2017-12-09.tar.xz -q --show-progress
  tar xf debian-9.3-minimal-armhf-2017-12-09.tar.xz -C .
}

# main.
while true; do
	main=`/usr/bin/zenity --title="Build ARM Image for Beaglebone Black."\
		--width=$width --height=$height --list --column="Configure Packages:"\
		"ARM Cross Compiler: GCC" "Bootloader: U-Boot"\
      		"Linux Kernel" "Root File System"\
      		"Setup microSD card" "Install Kernel and Root File System" 2>/dev/null`

	case "${main}" in
		"ARM Cross Compiler: GCC") gcc_arm;;
		"Bootloader: U-Boot") uboot ;;
                "Linux Kernel") kernel ;;
		"Root File System") fs_build ;;
                "Setup microSD card") sdcard_build ;;
                "Install Kernel and Root File System") hack_build ;;
        	*)
		exit 1
	esac
done
